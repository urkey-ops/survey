<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Custom Survey App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex items-center justify-center">

<div id="root" class="w-full"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // A simple, reusable Star SVG icon component
    const StarIcon = ({ filled }) => (
        <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill={filled ? "currentColor" : "none"}
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={`h-10 w-10 transition-colors ${filled ? 'text-yellow-400' : 'text-gray-300'}`}
        >
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
        </svg>
    );

    // Main application component
    const App = () => {
        const questions = [
            { id: 'q1', label: 'Write us about your experience today. Any comment or suggestion?', type: 'text' },
            { id: 'q2', label: 'Overall, how satisfied were you with your visit today?', type: 'emoji', options: [{ value: 'Sad', emoji: 'üòû' }, { value: 'Neutral', emoji: 'üòê' }, { value: 'Happy', emoji: 'üòä' }] },
            { id: 'q3', label: 'How would you rate the cleanliness of the facility?', type: 'linear-scale', min: 1, max: 5 },
            { id: 'q4', label: 'How friendly was the volunteer staff?', type: 'star-rating', max: 5 },
            { id: 'q5', label: 'A little about yourself... How young are you?', type: 'single-choice', options: ['<18', '18-26', '26-50', '51-75', '75+'] },
            { id: 'q6', label: 'Where are you from?', type: 'single-choice-other', options: ['USA', 'South America', 'Canada', 'India', 'Other'] },
            { id: 'q7', label: 'How did you first hear about us?', type: 'multiple-choice-other', options: ['Drove by', 'Friends/Family', 'Internet', 'Social Media', 'Other'] },
            { id: 'q8', label: 'Name', type: 'text' },
            { id: 'q9', label: 'Email', type: 'email' },
            { id: 'q10', label: 'Subscribe to e-newsletter', type: 'checkbox', options: ['Yes', 'No'] }
        ];

        const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
        const [answers, setAnswers] = useState({});
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [showThankYou, setShowThankYou] = useState(false);
        const [countdown, setCountdown] = useState(10);
        const [submissionError, setSubmissionError] = useState('');
        const [validationErrors, setValidationErrors] = useState({});

        const countdownRef = useRef(null);
        const firstInputRef = useRef(null);

        useEffect(() => {
            if (currentQuestionIndex === questions.length) {
                setCountdown(10);
                countdownRef.current = setInterval(() => {
                    setCountdown(prev => {
                        if (prev <= 1) {
                            clearInterval(countdownRef.current);
                            handleSubmit();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(countdownRef.current);
            }
        }, [currentQuestionIndex, questions.length]);

        useEffect(() => {
            if (firstInputRef.current) {
                firstInputRef.current.focus();
            }
        }, [currentQuestionIndex]);

        const isQuestionAnswered = () => {
            const currentQuestion = questions[currentQuestionIndex];
            if (!currentQuestion) return true;

            const currentAnswer = answers[currentQuestion.id];
            const otherAnswer = answers[`${currentQuestion.id}-other`];

            switch (currentQuestion.type) {
                case 'text':
                case 'email':
                case 'emoji':
                case 'linear-scale':
                case 'star-rating':
                case 'single-choice':
                case 'checkbox':
                    return !!currentAnswer && (Array.isArray(currentAnswer) ? currentAnswer.length > 0 : true);
                case 'single-choice-other':
                    return currentAnswer === 'Other' ? !!otherAnswer : !!currentAnswer;
                case 'multiple-choice-other':
                    return (currentAnswer && currentAnswer.length > 0) && (!currentAnswer.includes('Other') || (currentAnswer.includes('Other') && !!otherAnswer));
                default:
                    return false;
            }
        };

        const handleNextQuestion = () => {
            if (!isQuestionAnswered()) {
                setValidationErrors({ ...validationErrors, [questions[currentQuestionIndex].id]: 'Please provide a valid answer.' });
                return;
            }
            setValidationErrors({});
            setCurrentQuestionIndex(currentQuestionIndex + 1);
        };

        const handlePreviousQuestion = () => {
            if (currentQuestionIndex > 0) {
                setCurrentQuestionIndex(currentQuestionIndex - 1);
            }
        };

        const handleAnswer = (questionId, value, extraValue = null) => {
            setAnswers(prevAnswers => {
                let newAnswers = { ...prevAnswers };
                const currentQuestion = questions.find(q => q.id === questionId);
                if (currentQuestion.type === 'multiple-choice-other' || currentQuestion.type === 'checkbox') {
                    const currentArray = newAnswers[questionId] || [];
                    if (currentArray.includes(value)) {
                        newAnswers[questionId] = currentArray.filter(item => item !== value);
                    } else {
                        newAnswers[questionId] = [...currentArray, value];
                    }
                } else {
                    newAnswers[questionId] = value;
                }

                if (extraValue !== null) {
                    newAnswers[`${questionId}-other`] = extraValue;
                } else if (value !== 'Other' && currentQuestion.type.includes('other')) {
                    delete newAnswers[`${questionId}-other`];
                }
                return newAnswers;
            });

            setValidationErrors({ ...validationErrors, [questionId]: '' });
        };

        const handleSubmit = async (event) => {
            if (event) event.preventDefault();

            if (!isQuestionAnswered() && currentQuestionIndex < questions.length) {
                setSubmissionError('Please answer the current question before submitting.');
                return;
            }

            if (isSubmitting) return;

            setIsSubmitting(true);
            setSubmissionError('');
            const data = { timestamp: new Date().toISOString(), ...answers };

            const isDeployed = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
            const submitUrl = isDeployed
                ? `/.netlify/functions/submit-survey`
                : 'https://jsonplaceholder.typicode.com/posts';

            try {
                const response = await fetch(submitUrl, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Network response was not ok');

                console.log('Survey submitted successfully!', await response.json());
                setShowThankYou(true);
            } catch (error) {
                console.error("Submission failed:", error);
                setSubmissionError('Submission failed. Please try again.');
            } finally {
                setIsSubmitting(false);
            }
        };

        const resetSurvey = () => {
            setCurrentQuestionIndex(0);
            setAnswers({});
            setShowThankYou(false);
            setSubmissionError('');
            setValidationErrors({});
            clearInterval(countdownRef.current);
            window.scrollTo(0, 0);
            if (firstInputRef.current) {
                firstInputRef.current.focus();
            }
        };

        const currentQuestion = questions[currentQuestionIndex];
        const isLastQuestion = currentQuestionIndex === questions.length - 1;

        // Reusable components for each question type
        const TextQuestion = ({ id, label, type }) => (
            <div className="flex flex-col items-start w-full">
                <label htmlFor={id} className="text-lg font-semibold text-gray-700 mb-2">{label}</label>
                <input
                    id={id}
                    ref={id === questions[0].id ? firstInputRef : null}
                    type={type}
                    value={answers[id] || ''}
                    onChange={(e) => handleAnswer(id, e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleNextQuestion()}
                    className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder={type === 'email' ? 'your@email.com' : 'Your answer...'}
                    aria-required="true"
                />
                {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
            </div>
        );

        const EmojiQuestion = ({ id, label, options }) => (
            <div className="flex flex-col items-center justify-center w-full">
                <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
                <div className="flex justify-center items-center gap-6 mt-4" role="radiogroup" aria-label={label}>
                    {options.map(option => (
                        <button
                            key={option.value}
                            onClick={() => handleAnswer(id, option.value)}
                            disabled={isSubmitting}
                            className={`flex flex-col items-center p-4 rounded-xl transition-all ${answers[id] === option.value ? 'bg-blue-500 text-white shadow-lg scale-110' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
                            aria-pressed={answers[id] === option.value}
                            aria-label={option.value}
                        >
                            <span className="text-4xl">{option.emoji}</span>
                            <span className="mt-2 text-sm">{option.value}</span>
                        </button>
                    ))}
                </div>
                {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
            </div>
        );

        const LinearScaleQuestion = ({ id, label, min, max }) => (
            <div className="flex flex-col items-center w-full">
                <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
                <div className="flex justify-center items-center w-full gap-4" role="radiogroup" aria-label={label}>
                    {[...Array(max - min + 1)].map((_, i) => {
                        const value = min + i;
                        return (
                            <button
                                key={value}
                                onClick={() => handleAnswer(id, value)}
                                disabled={isSubmitting}
                                className={`flex-1 py-3 px-2 rounded-lg text-lg font-bold transition-all ${answers[id] === value ? 'bg-blue-500 text-white scale-110' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
                                aria-pressed={answers[id] === value}
                                aria-label={`${value} out of ${max}`}
                            >
                                {value}
                            </button>
                        );
                    })}
                </div>
                {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
            </div>
        );

        const StarRatingQuestion = ({ id, label, max }) => (
            <div className="flex flex-col items-center w-full">
                <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
                <div className="flex items-center gap-1" role="radiogroup" aria-label={label}>
                    {[...Array(max)].map((_, i) => {
                        const ratingValue = i + 1;
                        return (
                            <button
                                key={ratingValue}
                                onClick={() => handleAnswer(id, ratingValue)}
                                disabled={isSubmitting}
                                className="p-1"
                                aria-pressed={ratingValue === answers[id]}
                                aria-label={`${ratingValue} stars out of ${max}`}
                            >
                                <StarIcon filled={ratingValue <= (answers[id] || 0)} />
                            </button>
                        );
                    })}
                </div>
                {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
            </div>
        );

        const SingleChoiceQuestion = ({ id, label, options, hasOther }) => (
            <div className="flex flex-col items-start w-full">
                <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 w-full" role="radiogroup" aria-label={label}>
                    {options.map(option => (
                        <button
                            key={option}
                            onClick={() => handleAnswer(id, option)}
                            disabled={isSubmitting}
                            className={`py-3 px-4 rounded-md transition-all ${answers[id] === option ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
                            aria-pressed={answers[id] === option}
                        >
                            {option}
                        </button>
                    ))}
                </div>
                {hasOther && answers[id] === 'Other' && (
                    <input
                        id={`${id}-other`}
                        type="text"
                        ref={id === questions[currentQuestionIndex].id ? firstInputRef : null}
                        value={answers[`${id}-other`] || ''}
                        onChange={(e) => handleAnswer(id, 'Other', e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleNextQuestion()}
                        className="mt-4 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Please specify..."
                        aria-required="true"
                    />
                )}
                {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
            </div>
        );

        const MultipleChoiceQuestion = ({ id, label, options, hasOther }) => (
            <div className="flex flex-col items-start w-full">
                <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 w-full" role="group" aria-label={label}>
                    {options.map(option => (
                        <button
                            key={option}
                            onClick={() => handleAnswer(id, option)}
                            disabled={isSubmitting}
                            className={`py-3 px-4 rounded-md transition-all ${answers[id] && answers[id].includes(option) ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
                            aria-pressed={answers[id] && answers[id].includes(option)}
                        >
                            {option}
                        </button>
                    ))}
                </div>
                {hasOther && answers[id] && answers[id].includes('Other') && (
                    <input
                        id={`${id}-other`}
                        type="text"
                        ref={id === questions[currentQuestionIndex].id ? firstInputRef : null}
                        value={answers[`${id}-other`] || ''}
                        onChange={(e) => setAnswers({ ...answers, [`${id}-other`]: e.target.value })}
                        onKeyDown={(e) => e.key === 'Enter' && handleNextQuestion()}
                        className="mt-4 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Please specify..."
                        aria-required="true"
                    />
                )}
                {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
            </div>
        );

        const ThankYouScreen = () => (
            <div className="flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg shadow-inner text-center">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Thank you for your feedback!</h2>
                <p className="text-gray-600 mb-4">The survey has been submitted successfully.</p>
                {submissionError && <p className="text-sm text-red-500 mb-4">{submissionError}</p>}
                <button
                    onClick={resetSurvey}
                    className="mt-4 py-2 px-4 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 transition"
                >
                    Start a New Survey
                </button>
            </div>
        );

        const FinalScreen = () => {
            const progressWidth = (countdown / 10) * 100;
            return (
                <div className="flex flex-col items-center justify-center w-full">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Thank you for your time!</h2>
                    <p className="text-gray-600 text-center mb-4">
                        Your survey will automatically submit in <b className="text-blue-500">{countdown}</b> seconds.
                    </p>
                    <div className="w-full h-2 bg-gray-200 rounded-full mb-4">
                        <div
                            className="h-full bg-blue-500 rounded-full transition-all duration-1000 ease-linear"
                            style={{ width: `${progressWidth}%` }}
                        ></div>
                    </div>
                    {submissionError && (
                        <div className="text-center w-full">
                            <p className="text-red-500 mb-2">{submissionError}</p>
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="py-2 px-4 rounded-md bg-red-500 text-white font-semibold hover:bg-red-600 transition"
                            >
                                Retry Submission
                            </button>
                        </div>
                    )}
                    {!submissionError && (
                        <div className="w-full flex justify-center mt-6">
                            <button
                                type="submit"
                                disabled={isSubmitting}
                                className="w-full sm:w-1/2 py-3 px-4 rounded-md bg-green-500 text-white font-semibold hover:bg-green-600 transition disabled:bg-gray-400"
                                aria-label="Submit Survey"
                            >
                                {isSubmitting ? 'Submitting...' : 'Submit Survey Now'}
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const renderQuestionComponent = () => {
            if (showThankYou) return <ThankYouScreen />;

            const currentQuestion = questions[currentQuestionIndex];
            if (!currentQuestion) return <FinalScreen />;

            const { id, type, label, options, min, max } = currentQuestion;

            switch (type) {
                case 'text':
                case 'email':
                    return <TextQuestion id={id} label={label} type={type} />;
                case 'emoji':
                    return <EmojiQuestion id={id} label={label} options={options} />;
                case 'linear-scale':
                    return <LinearScaleQuestion id={id} label={label} min={min} max={max} />;
                case 'star-rating':
                    return <StarRatingQuestion id={id} label={label} max={max} />;
                case 'single-choice':
                    return <SingleChoiceQuestion id={id} label={label} options={options} hasOther={false} />;
                case 'single-choice-other':
                    return <SingleChoiceQuestion id={id} label={label} options={options} hasOther={true} />;
                case 'multiple-choice-other':
                    return <MultipleChoiceQuestion id={id} label={label} options={options} hasOther={true} />;
                case 'checkbox':
                    return <MultipleChoiceQuestion id={id} label={label} options={options} hasOther={false} />;
                default:
                    return null;
            }
        };

        const showNavigation = currentQuestionIndex < questions.length;
        const showBackButton = currentQuestionIndex > 0;
        const showNextButton = currentQuestionIndex < questions.length;

        return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
                <div className="w-full max-w-xl">
                    <h1 className="text-3xl font-bold text-gray-900 mb-8 text-center">Customer Feedback</h1>

                    {showNavigation && (
                        <div className="w-full mb-6">
                            <div className="h-2 bg-gray-300 rounded-full overflow-hidden">
                                <div
                                    className="h-full bg-blue-500 transition-all duration-500 ease-in-out"
                                    style={{ width: `${(currentQuestionIndex / questions.length) * 100}%` }}
                                ></div>
                            </div>
                            <p className="text-right text-sm text-gray-600 mt-2">
                                Question {currentQuestionIndex + 1} of {questions.length}
                            </p>
                        </div>
                    )}

                    <div className={`p-8 bg-white rounded-lg shadow-lg transition-transform duration-500 transform ${currentQuestion ? 'scale-100 opacity-100' : 'scale-95 opacity-0'}`}>
                        <form onSubmit={handleSubmit}>
                            {renderQuestionComponent()}
                        </form>
                    </div>

                    {showNavigation && (
                        <div className="flex justify-between w-full max-w-xl mt-6">
                            <button
                                onClick={handlePreviousQuestion}
                                disabled={!showBackButton}
                                className={`py-2 px-4 rounded-md font-semibold transition ${showBackButton ? 'bg-gray-300 text-gray-800 hover:bg-gray-400' : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`}
                            >
                                Back
                            </button>
                            <button
                                onClick={isLastQuestion ? handleSubmit : handleNextQuestion}
                                disabled={isSubmitting || !isQuestionAnswered()}
                                className={`py-2 px-4 rounded-md text-white font-semibold transition ${isQuestionAnswered() && !isSubmitting ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-400 cursor-not-allowed'}`}
                            >
                                {isLastQuestion ? 'Submit' : 'Next'}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        );
    };

    // Render the App component
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
        <React.StrictMode>
            <App />
        </React.StrictMode>
    );
</script>
</body>
</html>

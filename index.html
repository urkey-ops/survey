import React, { useState, useEffect, useRef } from 'react';

// A simple, reusable Star SVG icon component
const StarIcon = ({ filled }) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill={filled ? "currentColor" : "none"}
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    className={`h-10 w-10 transition-colors ${filled ? 'text-yellow-400' : 'text-gray-300'}`}
  >
    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
  </svg>
);

// Main application component
const App = () => {
  // Define all question data here, inside the App component
  const questions = [
    { id: 'q1', label: 'Write us about your experience today. Any comment or suggestion?', type: 'text' },
    { id: 'q2', label: 'Overall, how satisfied were you with your visit today?', type: 'emoji', options: [{ value: 'Sad', emoji: 'üòû' }, { value: 'Neutral', emoji: 'üòê' }, { value: 'Happy', emoji: 'üòä' }] },
    { id: 'q3', label: 'How would you rate the cleanliness of the facility?', type: 'linear-scale', min: 1, max: 5 },
    { id: 'q4', label: 'How friendly was the volunteer staff?', type: 'star-rating', max: 5 },
    { id: 'q5', label: 'A little about yourself... How young are you?', type: 'single-choice', options: ['<18', '18-26', '26-50', '51-75', '75+'] },
    { id: 'q6', label: 'Where are you from?', type: 'single-choice-other', options: ['USA', 'South America', 'Canada', 'India', 'Other'] },
    { id: 'q7', label: 'How did you first hear about us?', type: 'multiple-choice-other', options: ['Drove by', 'Friends/Family', 'Internet', 'Social Media', 'Other'] },
    { id: 'q8', label: 'Name', type: 'text' },
    { id: 'q9', label: 'Email', type: 'email' },
    { id: 'q10', label: 'Subscribe to e-newsletter', type: 'checkbox', options: ['Yes', 'No'] }
  ];

  // State for survey logic
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [answers, setAnswers] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showThankYou, setShowThankYou] = useState(false);
  const [countdown, setCountdown] = useState(10);
  const [submissionError, setSubmissionError] = useState('');
  const [validationErrors, setValidationErrors] = useState({});

  const countdownRef = useRef(null);
  const firstInputRef = useRef(null);

  // Auto-submit timer logic for the final screen
  useEffect(() => {
    if (currentQuestionIndex === questions.length) {
      setCountdown(10);
      countdownRef.current = setInterval(() => {
        setCountdown(prev => {
          if (prev <= 1) {
            clearInterval(countdownRef.current);
            handleSubmit();
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      return () => clearInterval(countdownRef.current);
    }
  }, [currentQuestionIndex]);

  // Focus management
  useEffect(() => {
    if (firstInputRef.current) {
      firstInputRef.current.focus();
    }
  }, [currentQuestionIndex]);

  // Function to advance to the next question
  const handleNextQuestion = () => {
    const currentQuestion = questions[currentQuestionIndex];
    let error = '';
    const currentAnswer = answers[currentQuestion.id];

    // Validation for each question type
    if (currentQuestion.type === 'text' && !currentAnswer) {
      error = 'This field cannot be empty.';
    } else if (currentQuestion.type === 'email' && (!currentAnswer || !currentAnswer.includes('@'))) {
      error = 'Please enter a valid email address.';
    } else if (currentQuestion.type === 'single-choice-other' && currentAnswer === 'Other' && !answers[`${currentQuestion.id}-other`]) {
      error = 'Please specify your answer.';
    } else if (currentQuestion.type === 'multiple-choice-other' && (!currentAnswer || currentAnswer.length === 0)) {
      error = 'Please select at least one option.';
    } else if (currentQuestion.type === 'emoji' && !currentAnswer) {
      error = 'Please select an emoji.';
    } else if (currentQuestion.type === 'linear-scale' && !currentAnswer) {
      error = 'Please select a rating.';
    } else if (currentQuestion.type === 'star-rating' && !currentAnswer) {
      error = 'Please select a star rating.';
    } else if (currentQuestion.type === 'single-choice' && !currentAnswer) {
      error = 'Please select an option.';
    } else if (currentQuestion.type === 'checkbox' && (!currentAnswer || currentAnswer.length === 0)) {
      error = 'Please select an option.';
    }

    if (error) {
      setValidationErrors({ ...validationErrors, [currentQuestion.id]: error });
      return; // Block progression
    }

    setValidationErrors({});
    setCurrentQuestionIndex(currentQuestionIndex + 1);
  };

  // Handle a user's answer
  const handleAnswer = (questionId, value, extraValue = null) => {
    setAnswers(prevAnswers => {
      let newAnswers = { ...prevAnswers };
      const currentQuestion = questions.find(q => q.id === questionId);
      if (currentQuestion.type === 'multiple-choice-other' || currentQuestion.type === 'checkbox') {
        const currentArray = newAnswers[questionId] || [];
        if (currentArray.includes(value)) {
          newAnswers[questionId] = currentArray.filter(item => item !== value);
        } else {
          newAnswers[questionId] = [...currentArray, value];
        }
      } else {
        newAnswers[questionId] = value;
      }

      if (extraValue !== null) {
        newAnswers[`${questionId}-other`] = extraValue;
      }
      return newAnswers;
    });

    // Clear validation error on interaction
    setValidationErrors({ ...validationErrors, [questionId]: '' });

    // Automatically advance for simple, one-click answer types
    const currentQuestion = questions[currentQuestionIndex];
    const oneClickTypes = ['emoji', 'linear-scale', 'star-rating', 'single-choice'];
    if (oneClickTypes.includes(currentQuestion.type) && currentQuestion.id !== 'q6') {
      setTimeout(handleNextQuestion, 300);
    }
  };

  // Handle survey submission
  const handleSubmit = async (event) => {
    if (event) event.preventDefault();

    // Final validation before submission
    const finalErrors = {};
    questions.forEach(q => {
      if (!answers[q.id]) {
        finalErrors[q.id] = 'This question is required.';
      }
    });

    if (Object.keys(finalErrors).length > 0) {
      setSubmissionError('Please answer all required questions.');
      setValidationErrors(finalErrors);
      return;
    }

    if (isSubmitting) return;

    setIsSubmitting(true);
    setSubmissionError('');
    const data = { timestamp: new Date().toISOString(), ...answers };

    // Determine URL based on environment
    const isDeployed = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
    const submitUrl = isDeployed
      ? `/.netlify/functions/submit-survey`
      : 'https://jsonplaceholder.typicode.com/posts'; // Dummy URL for testing

    try {
      const response = await fetch(submitUrl, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      });
      if (!response.ok) throw new Error('Network response was not ok');

      console.log('Survey submitted successfully!', await response.json());
      setShowThankYou(true);
    } catch (error) {
      console.error("Submission failed:", error);
      setSubmissionError('Submission failed. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  // Reset the survey to its initial state
  const resetSurvey = () => {
    setCurrentQuestionIndex(0);
    setAnswers({});
    setShowThankYou(false);
    setSubmissionError('');
    setValidationErrors({});
    clearInterval(countdownRef.current);
    window.scrollTo(0, 0);
    if (firstInputRef.current) {
      firstInputRef.current.focus();
    }
  };

  const currentQuestion = questions[currentQuestionIndex];
  const isLastQuestion = currentQuestionIndex === questions.length - 1;

  // Reusable components for each question type
  function TextQuestion({ id, label, type }) {
    return (
      <div className="flex flex-col items-start w-full">
        <label htmlFor={id} className="text-lg font-semibold text-gray-700 mb-2">{label}</label>
        <input
          id={id}
          ref={id === questions[0].id ? firstInputRef : null}
          type={type}
          value={answers[id] || ''}
          onChange={(e) => handleAnswer(id, e.target.value)}
          className="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder={type === 'email' ? 'your@email.com' : 'Your answer...'}
          aria-required="true"
        />
        {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
        <button
          onClick={handleNextQuestion}
          disabled={isSubmitting || !!validationErrors[id]}
          className="mt-6 w-full py-2 px-4 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          aria-label="Next Question"
        >
          Next
        </button>
      </div>
    );
  }

  function EmojiQuestion({ id, label, options }) {
    return (
      <div className="flex flex-col items-center justify-center w-full">
        <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
        <div className="flex justify-center items-center gap-6 mt-4" role="radiogroup" aria-label={label}>
          {options.map(option => (
            <button
              key={option.value}
              onClick={() => handleAnswer(id, option.value)}
              disabled={isSubmitting}
              className={`flex flex-col items-center p-4 rounded-xl transition-all ${answers[id] === option.value ? 'bg-blue-500 text-white shadow-lg scale-110' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
              aria-pressed={answers[id] === option.value}
              aria-label={option.value}
            >
              <span className="text-4xl">{option.emoji}</span>
              <span className="mt-2 text-sm">{option.value}</span>
            </button>
          ))}
        </div>
        {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
      </div>
    );
  }

  function LinearScaleQuestion({ id, label, min, max }) {
    return (
      <div className="flex flex-col items-center w-full">
        <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
        <div className="flex justify-center items-center w-full gap-4" role="radiogroup" aria-label={label}>
          {[...Array(max - min + 1)].map((_, i) => {
            const value = min + i;
            return (
              <button
                key={value}
                onClick={() => handleAnswer(id, value)}
                disabled={isSubmitting}
                className={`flex-1 py-3 px-2 rounded-lg text-lg font-bold transition-all ${answers[id] === value ? 'bg-blue-500 text-white scale-110' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
                aria-pressed={answers[id] === value}
                aria-label={`${value} out of ${max}`}
              >
                {value}
              </button>
            );
          })}
        </div>
        {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
      </div>
    );
  }

  function StarRatingQuestion({ id, label, max }) {
    return (
      <div className="flex flex-col items-center w-full">
        <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
        <div className="flex items-center gap-1" role="radiogroup" aria-label={label}>
          {[...Array(max)].map((_, i) => {
            const ratingValue = i + 1;
            return (
              <button
                key={ratingValue}
                onClick={() => handleAnswer(id, ratingValue)}
                disabled={isSubmitting}
                className="p-1"
                aria-pressed={ratingValue === answers[id]}
                aria-label={`${ratingValue} stars out of ${max}`}
              >
                <StarIcon filled={ratingValue <= (answers[id] || 0)} />
              </button>
            );
          })}
        </div>
        {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
      </div>
    );
  }

  function SingleChoiceQuestion({ id, label, options, hasOther }) {
    return (
      <div className="flex flex-col items-start w-full">
        <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 w-full" role="radiogroup" aria-label={label}>
          {options.map(option => (
            <button
              key={option}
              onClick={() => handleAnswer(id, option)}
              disabled={isSubmitting}
              className={`py-3 px-4 rounded-md transition-all ${answers[id] === option ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
              aria-pressed={answers[id] === option}
            >
              {option}
            </button>
          ))}
        </div>
        {hasOther && answers[id] === 'Other' && (
          <input
            id={`${id}-other`}
            type="text"
            value={answers[`${id}-other`] || ''}
            onChange={(e) => setAnswers(prev => ({ ...prev, [`${id}-other`]: e.target.value }))}
            className="mt-4 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Please specify..."
            aria-required="true"
          />
        )}
        {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
        <button
          onClick={handleNextQuestion}
          disabled={isSubmitting || (hasOther && answers[id] === 'Other' && !answers[`${id}-other`])}
          className="mt-6 w-full py-2 px-4 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          aria-label="Next Question"
        >
          Next
        </button>
      </div>
    );
  }

  function MultipleChoiceQuestion({ id, label, options, hasOther }) {
    return (
      <div className="flex flex-col items-start w-full">
        <h2 className="text-lg font-semibold text-gray-700 mb-4">{label}</h2>
        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 w-full" role="group" aria-label={label}>
          {options.map(option => (
            <button
              key={option}
              onClick={() => handleAnswer(id, option)}
              disabled={isSubmitting}
              className={`py-3 px-4 rounded-md transition-all ${answers[id] && answers[id].includes(option) ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
              aria-pressed={answers[id] && answers[id].includes(option)}
            >
              {option}
            </button>
          ))}
        </div>
        {hasOther && answers[id] && answers[id].includes('Other') && (
          <input
            id={`${id}-other`}
            type="text"
            value={answers[`${id}-other`] || ''}
            onChange={(e) => setAnswers({ ...answers, [`${id}-other`]: e.target.value })}
            className="mt-4 w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Please specify..."
            aria-required="true"
          />
        )}
        {validationErrors[id] && <p className="text-red-500 text-sm mt-1">{validationErrors[id]}</p>}
        <button
          onClick={handleNextQuestion}
          disabled={isSubmitting || !!validationErrors[id]}
          className="mt-6 w-full py-2 px-4 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
          aria-label="Next Question"
        >
          Next
        </button>
      </div>
    );
  }

  function ThankYouScreen() {
    return (
      <div className="flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg shadow-inner text-center">
        <h2 className="text-2xl font-bold text-gray-800 mb-4">Thank you for your feedback!</h2>
        <p className="text-gray-600 mb-4">The survey has been submitted successfully.</p>
        {submissionError && <p className="text-sm text-red-500 mb-4">{submissionError}</p>}
        <button
          onClick={resetSurvey}
          className="mt-4 py-2 px-4 rounded-md bg-blue-500 text-white font-semibold hover:bg-blue-600 transition"
        >
          Start a New Survey
        </button>
      </div>
    );
  }

  function FinalScreen() {
    const progressWidth = (countdown / 10) * 100;
    return (
      <div className="flex flex-col items-center justify-center w-full">
        <h2 className="text-2xl font-bold text-gray-800 mb-4">Thank you for your time!</h2>
        <p className="text-gray-600 text-center mb-4">
          Your survey will automatically submit in <b className="text-blue-500">{countdown}</b> seconds.
        </p>
        <div className="w-full h-2 bg-gray-200 rounded-full mb-4">
          <div
            className="h-full bg-blue-500 rounded-full transition-all duration-1000 ease-linear"
            style={{ width: `${progressWidth}%` }}
          ></div>
        </div>
        {submissionError && (
          <div className="text-center w-full">
            <p className="text-red-500 mb-2">{submissionError}</p>
            <button
              onClick={handleSubmit}
              disabled={isSubmitting}
              className="py-2 px-4 rounded-md bg-red-500 text-white font-semibold hover:bg-red-600 transition"
            >
              Retry Submission
            </button>
          </div>
        )}
        {!submissionError && (
          <div className="w-full flex justify-center mt-6">
            <button
              type="submit"
              disabled={isSubmitting}
              className="w-full sm:w-1/2 py-3 px-4 rounded-md bg-green-500 text-white font-semibold hover:bg-green-600 transition disabled:bg-gray-400"
              aria-label="Submit Survey"
            >
              {isSubmitting ? 'Submitting...' : 'Submit Survey Now'}
            </button>
          </div>
        )}
      </div>
    );
  }

  // Render different components based on question type
  const renderQuestionComponent = () => {
    if (showThankYou) return <ThankYouScreen />;

    const currentQuestion = questions[currentQuestionIndex];
    if (!currentQuestion) return <FinalScreen />;

    const { id, type, label, options, min, max } = currentQuestion;

    switch (type) {
      case 'text':
      case 'email':
        return <TextQuestion id={id} label={label} type={type} />;
      case 'emoji':
        return <EmojiQuestion id={id} label={label} options={options} />;
      case 'linear-scale':
        return <LinearScaleQuestion id={id} label={label} min={min} max={max} />;
      case 'star-rating':
        return <StarRatingQuestion id={id} label={label} max={max} />;
      case 'single-choice':
        return <SingleChoiceQuestion id={id} label={label} options={options} hasOther={false} />;
      case 'single-choice-other':
        return <SingleChoiceQuestion id={id} label={label} options={options} hasOther={true} />;
      case 'multiple-choice-other':
        return <MultipleChoiceQuestion id={id} label={label} options={options} hasOther={true} />;
      case 'checkbox':
        return <MultipleChoiceQuestion id={id} label={label} options={options} hasOther={false} />;
      default:
        return null;
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
      <div className="w-full max-w-xl">
        <div className={`p-8 bg-white rounded-lg shadow-lg transition-transform duration-500 transform ${currentQuestion ? 'scale-100 opacity-100' : 'scale-95 opacity-0'}`}>
          <h1 className="text-3xl font-bold text-gray-900 mb-8 text-center">Customer Feedback</h1>
          <form onSubmit={handleSubmit}>
            {renderQuestionComponent()}
          </form>
        </div>
      </div>
    </div>
  );
};

export default App;
